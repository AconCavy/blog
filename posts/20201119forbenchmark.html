<!DOCTYPE html><html lang="ja"><head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline';
img-src 'self' * data: *.w3.org; 
child-src 'none';
frame-src 'self' *.twitter.com;
font-src 'self' *.fontawesome.com;
connect-src 'self' *.fontawesome.com *.typekit.net;
style-src 'self' 'unsafe-inline';
script-src 'self' 'unsafe-eval' *.twitter.com *.typekit.net;">

    <title>acon.log - .NET Core 3.1&#x3068;.NET 5&#x306E;for-loop&#x306E;&#x901F;&#x5EA6;&#x6BD4;&#x8F03;</title>

    <link rel="icon" href="/assets/images/favicon.svg" type="text/svg+xml">
    <link href="/mirror/cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/style.css" type="text/css">
    <script src="/assets/vendor/adobe/adobe_fonts.js"></script>

    
<meta property="og:title" content=".NET Core 3.1&amp;#x3068;.NET 5&amp;#x306E;for-loop&amp;#x306E;&amp;#x901F;&amp;#x5EA6;&amp;#x6BD4;&amp;#x8F03;">
<meta property="og:description" content="">
<meta property="og:image" content="https://aconcavy.github.io/assets/images/icon.webp">
<meta property="og:url" content="https://aconcavy.github.io/posts/20201119forbenchmark">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="acon.log">
<meta name="twitter:image" content="https://aconcavy.github.io/assets/images/icon.webp">


</head>

<body>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top shadow-sm" id="mainNav">
    <div class="container">
        <a class="navbar-brand" href="/">acon.log</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav ms-auto">
    <li class="nav-item">
        <a class="nav-link" href="/posts">Posts</a>
    </li>
</ul>

        </div>
    </div>
</nav>


<header>
</header>


<div class="container">
    <div class="row">
        <div id="content">

                <div class="card shadow-sm">
                    <div class="card-body p-md-5">
                        
<div class="post-header mb-5">
    <h1 class="card-title post-title">.NET Core 3.1&#x3068;.NET 5&#x306E;for-loop&#x306E;&#x901F;&#x5EA6;&#x6BD4;&#x8F03;</h1>

    <div class="card-text post-meta">
        Published on Thursday, 19 November 2020
    </div>
    <div class="card-text post-meta">
        Updated on Thursday, 19 November 2020
    </div>

        <div class="mt-3 mb-4">
                <a href="/tags/dotnet" class="badge badge-light"> dotnet</a>
                <a href="/tags/csharp" class="badge badge-light"> csharp</a>
        </div>

    <hr>
</div>

                        <div class="post-body">
                            <h2 id="section">はじめに</h2>
<p>.NET 5でいろいろなパフォーマンスが向上したらしいので、1次元配列、2次元配列、2次元ジャグ配列、3次元配列、3次元配列のfor-loopのベンチマークを取ってみた。</p>
<h2 id="section-1">環境</h2>
<ul>
<li>OS: Windows 10</li>
<li>CPU: AMD Ryzen 5 3600</li>
<li>SDK: .NET 5.0</li>
<li>BenchmarkDotnet: 0.12.1</li>
</ul>
<h3 id="section-2">計測対象</h3>
<ul>
<li>Runtimes
<ul>
<li>.NET Core 3.1.9</li>
<li>.NET 5</li>
</ul>
</li>
<li>Targets
<ul>
<li>1次元配列 (1e6)</li>
<li>2次元配列 (1e3 * 1e3)</li>
<li>2次元ジャグ配列 (1e3 * 1e3)</li>
<li>3次元配列 (1e2 <em>1e2</em> 1e2)</li>
<li>3次元ジャグ配列 (1e2 <em>1e2</em> 1e2)</li>
</ul>
</li>
</ul>
<h3 id="section-3">操作</h3>
<p>全ての要素に値を代入</p>
<h3 id="section-4">スクリプト</h3>
<pre><code class="language-csharp line-numbers">using BenchmarkDotNet.Attributes;
using BenchmarkDotNet.Jobs;

namespace BenchmarkSharp
{
    [SimpleJob(RuntimeMoniker.NetCoreApp31, baseline: true)]
    [SimpleJob(RuntimeMoniker.NetCoreApp50)]
    [MemoryDiagnoser]
    public class ForLoopBenchmark
    {
        private const int Size1 = (int) 1e6;
        private const int Size2 = (int) 1e3;
        private const int Size3 = (int) 1e2;
        private int[] _dim1;
        private int[,] _dim2;
        private int[][] _dim2Jagged;
        private int[,,] _dim3;
        private int[][][] _dim3Jagged;

        [GlobalSetup]
        public void Setup()
        {
            _dim1 = new int[Size1];
            _dim2 = new int[Size2, Size2];
            _dim3 = new int[Size3, Size3, Size3];
            _dim2Jagged = new int[Size2][];
            for (var i = 0; i &lt; _dim2Jagged.Length; i++) _dim2Jagged[i] = new int[Size2];
            _dim3Jagged = new int[Size3][][];
            for (var i = 0; i &lt; _dim3Jagged.Length; i++)
            {
                _dim3Jagged[i] = new int[Size3][];
                for (var j = 0; j &lt; _dim3Jagged[i].Length; j++)
                {
                    _dim3Jagged[i][j] = new int[Size2];
                }
            }
        }

        [Benchmark]
        public void Dim1()
        {
            for (var i = 0; i &lt; _dim1.Length; i++) _dim1[i] = i;
        }

        [Benchmark]
        public void Dim2()
        {
            for (var i = 0; i &lt; _dim2.GetLength(0); i++)
            for (var j = 0; j &lt; _dim2.GetLength(1); j++)
                _dim2[i, j] = j;
        }

        [Benchmark]
        public void Dim2Jagged()
        {
            for (var i = 0; i &lt; _dim2Jagged.Length; i++)
            for (var j = 0; j &lt; _dim2Jagged[i].Length; j++)
                _dim2Jagged[i][j] = j;
        }

        [Benchmark]
        public void Dim3()
        {
            for (var i = 0; i &lt; _dim3.GetLength(0); i++)
            for (var j = 0; j &lt; _dim3.GetLength(1); j++)
            for (var k = 0; k &lt; _dim3.GetLength(2); k++)
                _dim3[i, j, k] = k;
        }

        [Benchmark]
        public void Dim3Jagged()
        {
            for (var i = 0; i &lt; _dim3Jagged.Length; i++)
            for (var j = 0; j &lt; _dim3Jagged[i].Length; j++)
            for (var k = 0; k &lt; _dim3Jagged[i][j].Length; k++)
                _dim3Jagged[i][j][k] = k;
        }
    }
}
</code></pre>
<h2 id="section-5">結果</h2>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th>Method</th>
<th>Job</th>
<th>Runtime</th>
<th style="text-align: right;">Mean</th>
<th style="text-align: right;">Error</th>
<th style="text-align: right;">StdDev</th>
<th style="text-align: right;">Median</th>
<th style="text-align: right;">Ratio</th>
<th style="text-align: right;">RatioSD</th>
<th style="text-align: right;">Gen 0</th>
<th style="text-align: right;">Gen 1</th>
<th style="text-align: right;">Gen 2</th>
<th style="text-align: right;">Allocated</th>
</tr>
</thead>
<tbody>
<tr>
<td>Dim1</td>
<td>.NET Core 3.1</td>
<td>.NET Core 3.1</td>
<td style="text-align: right;">565.1 μs</td>
<td style="text-align: right;">3.35 μs</td>
<td style="text-align: right;">3.14 μs</td>
<td style="text-align: right;">566.0 μs</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">1 B</td>
</tr>
<tr>
<td>Dim1</td>
<td>.NET Core 5.0</td>
<td>.NET Core 5.0</td>
<td style="text-align: right;">525.8 μs</td>
<td style="text-align: right;">10.49 μs</td>
<td style="text-align: right;">24.53 μs</td>
<td style="text-align: right;">508.9 μs</td>
<td style="text-align: right;">0.92</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>Dim2</td>
<td>.NET Core 3.1</td>
<td>.NET Core 3.1</td>
<td style="text-align: right;">5,366.7 μs</td>
<td style="text-align: right;">47.74 μs</td>
<td style="text-align: right;">44.65 μs</td>
<td style="text-align: right;">5,357.6 μs</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">111 B</td>
</tr>
<tr>
<td>Dim2</td>
<td>.NET Core 5.0</td>
<td>.NET Core 5.0</td>
<td style="text-align: right;">3,544.6 μs</td>
<td style="text-align: right;">230.75 μs</td>
<td style="text-align: right;">680.38 μs</td>
<td style="text-align: right;">3,060.7 μs</td>
<td style="text-align: right;">0.64</td>
<td style="text-align: right;">0.13</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>Dim2Jagged</td>
<td>.NET Core 3.1</td>
<td>.NET Core 3.1</td>
<td style="text-align: right;">1,514.8 μs</td>
<td style="text-align: right;">29.53 μs</td>
<td style="text-align: right;">35.16 μs</td>
<td style="text-align: right;">1,522.0 μs</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
</tr>
<tr>
<td>Dim2Jagged</td>
<td>.NET Core 5.0</td>
<td>.NET Core 5.0</td>
<td style="text-align: right;">2,003.3 μs</td>
<td style="text-align: right;">8.14 μs</td>
<td style="text-align: right;">7.22 μs</td>
<td style="text-align: right;">2,001.9 μs</td>
<td style="text-align: right;">1.33</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>Dim3</td>
<td>.NET Core 3.1</td>
<td>.NET Core 3.1</td>
<td style="text-align: right;">5,209.7 μs</td>
<td style="text-align: right;">45.24 μs</td>
<td style="text-align: right;">40.10 μs</td>
<td style="text-align: right;">5,201.5 μs</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">10 B</td>
</tr>
<tr>
<td>Dim3</td>
<td>.NET Core 5.0</td>
<td>.NET Core 5.0</td>
<td style="text-align: right;">4,525.7 μs</td>
<td style="text-align: right;">246.02 μs</td>
<td style="text-align: right;">725.38 μs</td>
<td style="text-align: right;">4,114.5 μs</td>
<td style="text-align: right;">0.90</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>Dim3Jagged</td>
<td>.NET Core 3.1</td>
<td>.NET Core 3.1</td>
<td style="text-align: right;">18,504.2 μs</td>
<td style="text-align: right;">466.86 μs</td>
<td style="text-align: right;">1,376.55 μs</td>
<td style="text-align: right;">18,885.7 μs</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
</tr>
<tr>
<td>Dim3Jagged</td>
<td>.NET Core 5.0</td>
<td>.NET Core 5.0</td>
<td style="text-align: right;">17,920.7 μs</td>
<td style="text-align: right;">1,043.53 μs</td>
<td style="text-align: right;">3,076.86 μs</td>
<td style="text-align: right;">19,831.3 μs</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
<td style="text-align: right;">-</td>
</tr>
</tbody>
</table>
</div>
<h2 id="section-6">まとめ</h2>
<p>.NET 5.0は .NET Core 3.1に比べて</p>
<ul>
<li>1次元配列 -&gt; 10%程度高速</li>
<li>2次元配列 -&gt; 35%程度高速</li>
<li>2次元ジャグ配列 -&gt; 35%程度低速</li>
<li>3次元配列 -&gt; 10%程度高速</li>
<li>3次元ジャグ配列 -&gt; ほぼ一緒</li>
</ul>
<p>.NET 5.0において多次元配列と多次元ジャグ配列の各次元のサイズが同じ大きさであれば</p>
<ul>
<li>2次元 -&gt; ジャグ配列のほうが40%程度高速</li>
<li>3次元 -&gt; 配列のほうが75%程度高速</li>
</ul>

                        </div>
                        <div class="post-footer mt-5">
    <div class="share">
        <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" url="/posts/20201119forbenchmark" data-size="large">
            Tweet
        </a>
    </div>

    <hr>

    <div class="row justify-content-center">
        <div class="col-md-3 mt-3">
            <img class="rounded-circle" src="/assets/images/icon.svg" alt="icon">
        </div>
        <div class="col-md-3 mt-3">
            <h5 class="card-text">AconCavy</h5>
            <div class="card-text">C#が好きなひきこもり</div>
            <a class="nav-link fab fa-twitter fa-2x" href="https://twitter.com/AconCavy"></a>
            <a class="nav-link fab fa-github fa-2x" href="https://github.com/AconCavy"></a>
        </div>
    </div>
</div>

                    </div>
                </div>

        </div>
    </div>
</div>

<footer>
    <div class="container">
        <div class="row">
            <div class="col-md-12 text-center">
                <p>Copyright &#xA9; 2020-2022 AconCavy</p>
                <ul class="list-inline text-center small">
                        <li class="list-inline-item">
                            <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a>
                        </li>
                        <li class="list-inline-item">
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        </li>
                </ul>
            </div>
        </div>
    </div>
</footer>


<script src="/mirror/cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="/mirror/cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"></script>
<script src="/mirror/kit.fontawesome.com/defa8b99ee.js"></script>

<script src="/assets/vendor/prism/prism.js"></script>

<script async="" src="/mirror/platform.twitter.com/widgets.js" charset="utf-8"></script>





</body></html>