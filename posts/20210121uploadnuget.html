<!DOCTYPE html><html lang="ja"><head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline';
img-src 'self' * data: *.w3.org; 
child-src 'none';
frame-src 'self' *.twitter.com;
font-src 'self' *.fontawesome.com;
connect-src 'self' *.fontawesome.com *.typekit.net;
style-src 'self' 'unsafe-inline';
script-src 'self' 'unsafe-eval' *.twitter.com *.typekit.net;">

    <title>acon.log - GitHub Actions&#x304B;&#x3089;NuGet&#x306B;&#x30D1;&#x30C3;&#x30B1;&#x30FC;&#x30B8;&#x3092;&#x30A2;&#x30C3;&#x30D7;&#x30ED;&#x30FC;&#x30C9;&#x3057;&#x305F;</title>

    <link rel="icon" href="/blog/assets/images/favicon.svg" type="text/svg+xml">
    <link href="/blog/mirror/cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/blog/assets/css/style.css" type="text/css">
    <script src="/blog/assets/vendor/adobe/adobe_fonts.js"></script>

    
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="acon.log">
<meta property="og:title" content="GitHub Actions&amp;#x304B;&amp;#x3089;NuGet&amp;#x306B;&amp;#x30D1;&amp;#x30C3;&amp;#x30B1;&amp;#x30FC;&amp;#x30B8;&amp;#x3092;&amp;#x30A2;&amp;#x30C3;&amp;#x30D7;&amp;#x30ED;&amp;#x30FC;&amp;#x30C9;&amp;#x3057;&amp;#x305F;">
<meta property="og:description" content="">
<meta property="og:image" content="https://aconcavy.github.io/blog/assets/images/icon.webp">
<meta property="og:url" content="https://aconcavy.github.io/blog/posts/20210121uploadnuget">


</head>

<body>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top shadow-sm" id="mainNav">
    <div class="container">
        <a class="navbar-brand" href="/blog/">acon.log</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav ms-auto">
    <li class="nav-item">
        <a class="nav-link" href="/blog/posts">Posts</a>
    </li>
</ul>

        </div>
    </div>
</nav>


<header>
</header>


<div class="container">
    <div class="row">
        <div id="content">

                <div class="card shadow-sm">
                    <div class="card-body p-md-5">
                        
<div class="post-header mb-5">
    <h1 class="card-title post-title">GitHub Actions&#x304B;&#x3089;NuGet&#x306B;&#x30D1;&#x30C3;&#x30B1;&#x30FC;&#x30B8;&#x3092;&#x30A2;&#x30C3;&#x30D7;&#x30ED;&#x30FC;&#x30C9;&#x3057;&#x305F;</h1>

    <div class="card-text post-meta">
        Published on Thursday, 21 January 2021
    </div>
    <div class="card-text post-meta">
        Updated on Thursday, 21 January 2021
    </div>

        <div class="mt-3 mb-4">
                <a href="/blog/tags/dotnet" class="badge badge-light"> dotnet</a>
                <a href="/blog/tags/github-actions" class="badge badge-light"> GitHub Actions</a>
                <a href="/blog/tags/nuget" class="badge badge-light"> NuGet</a>
        </div>

    <hr>
</div>

                        <div class="post-body">
                            <h1 id="section">はじめに</h1>
<p>GitHub Actionsで.NETプロジェクトからNuGetパッケージの作成、Releaseの作成およびNuGetにパッケージをアップロードするまでをまとめた記事です。</p>
<p>リポジトリは<a href="https://github.com/AconCavy/Mulinq">こちら</a></p>
<h2 id="tldr">TL;DR</h2>
<ul>
<li>GitHub ActionsでNuGetパッケージを作成した。</li>
<li>作成したNuGetパッケージをNuGetにアップロードした。</li>
<li>タグからリリース/プレリリースを判断できるようにした。</li>
</ul>
<h1 id="net">対象の.NETプロジェクトの設定</h1>
<p>パッケージ化する.NETプロジェクトの<code>.csproj</code>ファイルを更新します。
今回はビルド構成として.NET 5と.NET Core 3.1のdllを生成するために、<code>TargetFrameworks</code>に<code>net5.0</code>と<code>netcoreapp3.1</code>を構成します。</p>
<p>そして、NuGetの情報を構成します。今回は<code>.csproj</code>に構成しましたが、<code>.nuspec</code>ファイルを作成してNuGet情報だけを切り離して構成することも可能なようです。
<code>PackageVersion</code>はcsprojをリリースのたびに変更せずに、ビルド時にバージョンを指定できるように、<code>$(Version)</code>の環境変数を使います。</p>
<pre><code class="language-xml line-numbers">&lt;Project Sdk=&quot;Microsoft.NET.Sdk&quot;&gt;

    &lt;PropertyGroup&gt;
        &lt;TargetFrameworks&gt;net5.0;netcoreapp3.1&lt;/TargetFrameworks&gt;
    &lt;/PropertyGroup&gt;
    
    &lt;!-- NuGet --&gt;
    &lt;PropertyGroup&gt;
        &lt;PackageId&gt;Mulinq&lt;/PackageId&gt;
        &lt;PackageVersion&gt;$(Version)&lt;/PackageVersion&gt;
        &lt;Title&gt;Mulinq&lt;/Title&gt;
        &lt;Authors&gt;AconCavy&lt;/Authors&gt;
        &lt;Description&gt;Mulinq is C# LINQ extensions for collections and for multidimensional arrays.&lt;/Description&gt;
        &lt;PackageProjectUrl&gt;https://github.com/AconCavy/Mulinq&lt;/PackageProjectUrl&gt;
        &lt;PackageLicenseExpression&gt;MIT&lt;/PackageLicenseExpression&gt;
        &lt;RepositoryUrl&gt;https://github.com/AconCavy/Mulinq&lt;/RepositoryUrl&gt;
        &lt;PackageTags&gt;LINQ&lt;/PackageTags&gt;
    &lt;/PropertyGroup&gt;

&lt;/Project&gt;
</code></pre>
<h1 id="nuget">NuGetの設定</h1>
<p>NuGetアカウントを持っていない場合はアカウントの作成をします。Microsoftアカウントから作成もできるみたいです。</p>
<p>NuGetパッケージのアップロードには、NuGetのAPIキーが必要なので、APIキーを生成します。
画面右上のユーザから、<code>API Keys</code>のページに移動し、<code>Create</code>フォームから、<code>Key Name</code>や<code>Package Owner</code>等必要な情報を埋め、APIキーを生成します。
生成に成功すると、<code>Manage</code>パネルに生成したAPIキーが並ぶので、<code>Copy</code>でAPIキーをコピーします。一度ページから離れてしまうと、再びコピーできなくなるので、できなくなった場合は<code>Regenerate</code>から再生成します。</p>
<p>コピーしたAPIキーをGitHubリポジトリの<code>Secrets</code>に登録することで、GitHub Actionsの環境変数としてアクセスできるようになります。リポジトリの<code>Setting -&gt; Secrets -&gt; New repository secret</code>で新しいシークレットを作成し、名前とAPIキーを登録します。今回は<code>NUGET_API_KEY</code>として登録しました。</p>
<h1 id="workflow">Workflowの作成</h1>
<p><a href="20201212createrepository">リポジトリを作成したときにやっておきたいこと</a>のReleaseの作成をもとにWorkflowを作成します。</p>
<p>RelaseのWorkflowを実行するトリガーとして、<code>v1.0.0</code>や<code>v1.0.0-alpha</code>のようなGitのタグがpushされたときに限定します。</p>
<pre><code class="language-yml line-numbers">on:
  push:
    tags: 
    - 'v[0-9]+.[0-9]+.[0-9]+*'
</code></pre>
<p>最初にテストを実行します。今回はTargetFrameworkが複数あるため、複数の.NET SDKをセットアップします。</p>
<pre><code class="language-yml line-numbers">jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout&#64;v2
    - name: Setup .NET 3.1.x
      uses: actions/setup-dotnet&#64;v1
      with:
        dotnet-version: 3.1.x
    - name: Setup .NET 5.0.x
      uses: actions/setup-dotnet&#64;v1
      with:
        dotnet-version: 5.0.x
    - name: Test
      run: dotnet test -c Release --verbosity normal
</code></pre>
<p>次にテストが成功した場合のみリリースを実行します。<code>needs: [test]</code>とすることで、<code>test</code>のjobが成功した場合のみ実行されるようになります。
まず、プロジェクトからNuGetパッケージを作成します。このとき、<code>-p:Version</code>にバージョンを指定します。タグのバージョン情報を取得するために、<code>${GITHUB_REF##*/v}</code>を指定します。</p>
<pre><code class="line-numbers">dotnet pack ./src/Mulinq/Mulinq.csproj -c Release -p:Version=${GITHUB_REF##*/v} -o ./publish
</code></pre>
<p><code>GITHUB_REF</code>の環境変数では、ワークフローをトリガーしたタグのrefを取得でき、<code>v1.0.0</code>のようなタグの場合は<code>refs/heads/v1.0.0</code>という文字列を取得できます。そこから<code>1.0.0</code>の部分だけ取得し、<code>Version</code>の環境変数に指定します。
ビルドに成功した場合は、<code>./publish</code>に<code>Mulinq.1.0.0.nupkg</code>が生成されます。</p>
<p>そして、NuGetのAPIを叩き、作成した<code>.nupkg</code>をアップロードします。<code>secrets.NUGET_API_KEY</code>から、リポジトリに登録したNuGetのAPIキーを参照します。<code>secrets.&lt;*&gt;</code>は上記で登録したシークレットの名前になります。</p>
<pre><code class="language-yml line-numbers">release:
    runs-on: ubuntu-latest
    needs: [test]
    steps:
    - uses: actions/checkout&#64;v2
    - name: Setup .NET Core 3.1.x
      uses: actions/setup-dotnet&#64;v1
      with:
        dotnet-version: 3.1.x
    - name: Setup .NET 5.0.x
      uses: actions/setup-dotnet&#64;v1
      with:
        dotnet-version: 5.0.x
    - name: Build
      run: dotnet pack ./src/Mulinq/Mulinq.csproj -c Release -p:Version=${GITHUB_REF##*/v} -o ./publish
    - name: Upload to NuGet
      run: dotnet nuget push ./publish/*.nupkg -k ${{ secrets.NUGET_API_KEY }} -s https://api.nuget.org/v3/index.json
    
    - name: Create Release
      id: create_release
      uses: actions/create-release&#64;v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: ${{ github.ref }}
        draft: false
        prerelease: ${{ contains(github.ref, '-') }}
</code></pre>
<p>また、GitHubにReleaseを作成します。
<code>prerelease</code>のプロパティに<code>true|false</code>を指定することで、作成するリリースがプレリリースか否かを指定できます。そのため、タグに<code>-</code>が含まれているかをチェックする<code>contains</code>関数を使用して、<code>v1.0.0</code>のような普通のリリースの場合と、<code>v1.0.0-alpha</code>のようなプレリリースを区別できるようにしました。</p>
<pre><code class="language-yml line-numbers">- name: Create Release
  id: create_release
  uses: actions/create-release&#64;v1
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  with:
    tag_name: ${{ github.ref }}
    release_name: ${{ github.ref }}
    draft: false
    prerelease: ${{ contains(github.ref, '-') }}
</code></pre>
<p>Workflow全体としては次のようになります。</p>
<pre><code class="language-yml line-numbers">name: Release

on:
  push:
    tags: 
    - 'v[0-9]+.[0-9]+.[0-9]+*'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout&#64;v2
    - name: Setup .NET 3.1.x
      uses: actions/setup-dotnet&#64;v1
      with:
        dotnet-version: 3.1.x
    - name: Setup .NET 5.0.x
      uses: actions/setup-dotnet&#64;v1
      with:
        dotnet-version: 5.0.x
    - name: Test
      run: dotnet test -c Release --verbosity normal
  
  release:
    runs-on: ubuntu-latest
    needs: [test]
    steps:
    - uses: actions/checkout&#64;v2
    - name: Setup .NET Core 3.1.x
      uses: actions/setup-dotnet&#64;v1
      with:
        dotnet-version: 3.1.x
    - name: Setup .NET 5.0.x
      uses: actions/setup-dotnet&#64;v1
      with:
        dotnet-version: 5.0.x
    - name: Build
      run: dotnet pack ./src/Mulinq/Mulinq.csproj -c Release -p:Version=${GITHUB_REF##*/v} -o ./publish
    - name: Upload to NuGet
      run: dotnet nuget push ./publish/*.nupkg -k ${{ secrets.NUGET_API_KEY }} -s https://api.nuget.org/v3/index.json
    
    - name: Create Release
      id: create_release
      uses: actions/create-release&#64;v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: ${{ github.ref }}
        draft: false
        prerelease: ${{ contains(github.ref, '-') }}
</code></pre>
<h1 id="workflow-1">Workflowの実行</h1>
<p>適当にコミットを作成し、<code>v0.0.1-alpha</code>というタグをつけ、GitHub上にプッシュします。</p>
<p>作成したWorkflowが実行され、テスト、ビルド、アップロード、Releaseの作成が行われます。</p>
<p>NuGetへアップロード直後は<code>Unlisted Packages</code>の状態でしたが、しばらくすると<code>Published Packages</code>になりました。</p>
<p><img src="assets/images/nuget_upload.webp" class="img-fluid" alt="succeeded upload to nuget"></p>
<p>GitHubのリリースのほうは、ちゃんと<code>Pre-Release</code>で作成されています。
<img src="assets/images/gha_prerelease.webp" class="img-fluid" alt="pre-release"></p>
<h1 id="section-1">まとめ</h1>
<ul>
<li>GitHub ActionsでNuGetパッケージを作成した。</li>
<li>作成したNuGetパッケージをNuGetにアップロードした。</li>
<li>タグからリリース/プレリリースを判断できるようにした。</li>
</ul>
<p>NuGetのパッケージ作成は怖くない！</p>

                        </div>
                        <div class="post-footer mt-5">
    <div class="share">
        <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" url="/blog/posts/20210121uploadnuget" data-size="large">
            Tweet
        </a>
    </div>

    <hr>

    <div class="row justify-content-center">
        <div class="col-md-3 mt-3">
            <img class="rounded-circle" src="/blog/assets/images/icon.svg" alt="icon">
        </div>
        <div class="col-md-3 mt-3">
            <h5 class="card-text">AconCavy</h5>
            <div class="card-text">C#が好きなひきこもり</div>
            <a class="nav-link fab fa-twitter fa-2x" href="https://twitter.com/AconCavy"></a>
            <a class="nav-link fab fa-github fa-2x" href="https://github.com/AconCavy"></a>
        </div>
    </div>
</div>

                    </div>
                </div>

        </div>
    </div>
</div>

<footer>
    <div class="container">
        <div class="row">
            <div class="col-md-12 text-center">
                <p>Copyright &#xA9; 2020-2022 AconCavy</p>
                <ul class="list-inline text-center small">
                        <li class="list-inline-item">
                            <a href="/blog/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a>
                        </li>
                        <li class="list-inline-item">
                            <a href="/blog/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        </li>
                </ul>
            </div>
        </div>
    </div>
</footer>


<script src="/blog/mirror/cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="/blog/mirror/cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"></script>
<script src="/blog/mirror/kit.fontawesome.com/defa8b99ee.js"></script>

<script src="/blog/assets/vendor/prism/prism.js"></script>

<script async="" src="/blog/mirror/platform.twitter.com/widgets.js" charset="utf-8"></script>





</body></html>